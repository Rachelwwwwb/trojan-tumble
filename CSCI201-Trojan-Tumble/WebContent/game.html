<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Trojan Tumble</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>

	<script type="text/javascript">
		
		/* ---------- Global Variables ----------*/
		var config = {
		    type: Phaser.AUTO,
		    width: 1680,
		    height: 975,
		    physics: {
		        default: 'arcade',
		        arcade: {
		            gravity: { y: 300 },
		            debug: false
		        }
		    },
		    scene: {
		        preload: preload,
		        create: create,
		        update: update
		    }
		};
		
		var game = new Phaser.Game(config);
		
		var player;
		var platforms;		
		var cursors;
		var coinCount = 0;		
		var coinText;
		var dungeon;
		/* ---------- End Global Variables ----------*/
		
		
		
		
		/* ---------- Load Assets ----------*/
		function preload ()
		{
		    this.load.image('dungeon', 'assets/dungeon.png');
		    this.load.image('ground', 'assets/ground2.png');
		    this.load.image('coin', 'assets/coin.png');
		
		    this.load.spritesheet('trojan', 'assets/trojan_sheet_idleSmall.png', { frameWidth: 48, frameHeight:  48});
		    this.load.spritesheet('trojanRun', 'assets/trojan_sheet_run_aligned-BASELINESmall.png', { frameWidth: 48, frameHeight:  48});
		    //this.trojanRun.anchor.setTo(0.5, 0.5);
		}
		/* ---------- 			----------*/
		
		
		
		/* ---------- Create Main Game Structure----------*/
		function create ()
		{
		    //  Add background
		    dungeon = this.add.tileSprite(840, 487.5, 1680, 975, 'dungeon');
		    
		    // Set bounds
		    this.physics.world.setBounds(0, 0, 3000, 3000);
			
			// Add platform group
		    platforms = this.physics.add.group({
		    	key: 'ground',
		    	repeat: 1000,
		    	setScale: { x: 0.4, y: 0.3}
		    });
		    platforms.enableBody = true;
			
		    // Initialize platform child
		    platforms.children.iterate(function (child) {
				
		        child.body.immovable = true;
		        child.active = false;
		
		    });
		    
		    
		    // The player and its settings
		    player = this.physics.add.sprite(100, 0, 'trojan');
		    player.setBounce(0.2);
		    player.setCollideWorldBounds(true);
		
		    //  Our player animations, turning, walking left and walking right.
		    this.anims.create({
		        key: 'left',
		        frames: this.anims.generateFrameNumbers('trojanRun', { start: 0, end: 3 }),
		        frameRate: 10,
		        repeat: -1
		    });
			
		    this.anims.create({
		        key: 'turn',
		        frames: this.anims.generateFrameNumbers('trojan', { start: 0, end: 3 }),
		        frameRate: 10,
		        repeat: -1
		    });
		    
		    this.anims.create({
		        key: 'right',
		        frames: this.anims.generateFrameNumbers('trojanRun', { start: 0, end: 3 }),
		        frameRate: 10,
		        repeat: -1
		    });
			
		    
		    //  Input Events
		    cursors = this.input.keyboard.createCursorKeys();
		
		    
		    
		    //  Some coins to collect, 12 in total, evenly spaced 70 pixels apart along the x axis
		    coins = this.physics.add.group({
		        key: 'coin',
		        repeat: 11,
		        setXY: { x: 12, y: 0, stepX: 140 },
		        setScale: { x: 0.01, y: 0.01 }
		    });
		
		    coins.children.iterate(function (child) {
		
		        //  Give each coin a slightly different bounce
		        child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
		
		    });
		
		    //  The score
		    coinText = this.add.text(16, 16, 'Coins: 0', { fontSize: '32px', fill: 'rgb(255,255,255)' });
		
		    //  Collide the player and the coins with the platforms
		    this.physics.add.collider(player, platforms);
		    this.physics.add.collider(coins, platforms);
		
		    //  Checks to see if the player overlaps with any of the coins, if he does call the collectCoin function
		    this.physics.add.overlap(player, coins, collectCoin, null, this);
			
		    // Loop infinitely and add platforms
		    this.timer = this.time.addEvent({ 
		    	delay: 1000, 
		    	callback: addPlatform, 
		    	callbackScope: this, 
		    	loop: true
		    });
		}
		/* ---------- 				 ----------*/
		
		
		/* ---------- Update Game Status Every Frame ----------*/
		function update ()
		{	
			// Move background and platforms up
			dungeon.tilePositionY += 2;
			platforms.setVelocityY(-125);
			
			// kill platforms that are out of bounds
			platforms.children.iterate(function (child) {
		        if (child.y <= 0) {
		            platforms.kill(child);
		        }
		    });
			
			/* coins.children.iterate(function (child) {
		        if (child.y <= 0) {
		            coins.kill(child);
		        }
		    }); */
			
		    // Set cursor event
		    if (cursors.left.isDown)
		    {
		        player.setVelocityX(-160);
		
		        player.anims.play('left', true);
            	player.flipX = true;

	        }
	        else if (cursors.right.isDown)
	        {
	            player.setVelocityX(160);
	
	            player.anims.play('right', true);
	            player.flipX = false;
	        }
	        else
	        {
	            player.setVelocityX(0);
	            player.anims.play('turn', true);
	        }
			
		    // Set player jump event
	        if (cursors.up.isDown && player.body.touching.down)
	        {
	            player.setVelocityY(-600);
	        }
	
	        
	        
	        if (player.y <= 0)
	        {
	            //kill player
	
	        }
    	
   
		}
		
		
		function collectCoin (player, coin)
		{
		    coin.disableBody(true, true);
		
		    //  Add and update the score
		    coinCount += 1;
		    coinText.setText('Coins: ' + coinCount);
		
		    if (coins.countActive(true) === 0)
		    {
		        //  A new batch of coins to collect
		        coins.children.iterate(function (child) {
		
		            child.enableBody(true, child.x, 975, true, true);
		            child.alive = true;
		
		        });
		    }
		}
		
		
		function addTile(x, y){
			//Get a tile that is not currently on screen
			var tile = platforms.getFirstDead();
			
			tile.active = true;
		    //Reset it to the specified coordinates
		    tile.enableBody(true, x, y);
		    console.log(tile.x);
		    tile.body.velocity.y = -125; 
		    tile.body.immovable = true;

		}
		
		function addPlatform(y){
			//Work out how many tiles we need to fit across the whole screen
		    var tilesNeeded = 20;
			
			if(typeof(y) == "undefined"){
				y = 975;
			}
			
			var tilesNeeded = Math.ceil(1600/51.2);
			
		    //Add a hole randomly somewhere
		    var hole = Math.floor(Math.random() * (tilesNeeded - 3)) + 1;
		
		    //Keep creating tiles next to each other until we have an entire row
		    //Don't add tiles where the random hole is
		    var skipped = false;
		    var curr_len = 0;
		    
		    for (var i = 0; i < tilesNeeded; i++){
		    	//randomly skip first part or last part
		    	var skip_factor = Math.random();
		    	if(skip_factor < 0.1 && !skipped && (curr_len == 0 || curr_len > 5)){
		    		break;
		    	}
		    	else if(skip_factor > 0.9 && !skipped){
		    		i += Math.floor((skip_factor - 0.9) * 3 * tilesNeeded);
		    		skipped = true;
		    	}
		    	
		    	
		    	//randomly add holes
		    	var hole_length = Math.floor(Math.random() * 3 + 1);
		    	var make_hole = Math.ceil(Math.random() * 5);
		    	if(make_hole == 3 && curr_len > 5){
		    		i+= hole_length;
		    		curr_len = 0;
		    		continue;
		    	}
		    	addTile(i*51.2, y);
		    	curr_len++;
		    	/* if(i != hole && i != hole+1){
		        	addTile(i*51.2, y);  
		    	} */
		    }
		}
		
	</script>

</body>

</html>